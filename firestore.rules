/**
 * @fileOverview Firestore Security Rules for ScriptScribbler.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. All user-generated content
 * (scripts, characters, notes, scenes) is stored in subcollections under the user's
 * unique ID, ensuring data isolation and simplifying security rules. It also includes
 * a rule for a public-write error reporting collection.
 *
 * Data Structure:
 * - /users/{userId}: Public-readable user profile information.
 * - /users/{userId}/scripts/{scriptId}: Core script documents.
 * - /users/{userId}/scripts/{scriptId}/[characters|notes|scenes|comments|versions|outline]/{docId}: Subcollections for script data.
 * - /error-reports/{reportId}: Collection for users to submit error logs.
 *
 * Key Security Decisions:
 * - User profiles (`/users/{userId}`) are world-readable to facilitate future social features,
 *   but only the owner can write to their own profile.
 * - All script-related data is nested under the user path, making ownership checks straightforward.
 * - Users can write to the `error-reports` collection but cannot read from it, protecting privacy.
 * - Users cannot list all other users in the system.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles. Profiles are world-readable
     * but only writable by the owner.
     * @path /users/{userId}
     */
    match /users/{userId} {
      function isOwner() {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get: if true; // Publicly readable profiles
      allow list: if false; // Prevent listing all users

      allow create, update, delete: if isOwner();
    }

    /**
     * @description Controls access to script documents. Scripts are publicly readable
     * to allow sharing, but only the owner can write.
     * @path /users/{userId}/scripts/{scriptId}
     */
    match /users/{userId}/scripts/{scriptId} {
      function isOwner() {
        return request.auth != null && request.auth.uid == userId;
      }
      allow read: if request.auth != null; // Any authenticated user can read scripts
      allow write: if isOwner();
    }

    /**
     * @description Controls access to script versions. Publicly readable but only owner can write.
     * @path /users/{userId}/scripts/{scriptId}/versions/{versionId}
     */
    match /users/{userId}/scripts/{scriptId}/versions/{versionId} {
      function isOwner() {
        return request.auth != null && request.auth.uid == userId;
      }
      allow read: if request.auth != null; // Any authenticated user can read versions
      allow write: if isOwner();
    }

    /**
     * @description Controls access to characters within a script. Publicly readable but only owner can write.
     * @path /users/{userId}/scripts/{scriptId}/characters/{characterId}
     */
    match /users/{userId}/scripts/{scriptId}/characters/{characterId} {
      function isOwner() {
        return request.auth != null && request.auth.uid == userId;
      }
      allow read: if request.auth != null; // Any authenticated user can read characters
      allow write: if isOwner();
    }

    /**
     * @description Controls access to notes within a script. Publicly readable but only owner can write.
     * @path /users/{userId}/scripts/{scriptId}/notes/{noteId}
     */
    match /users/{userId}/scripts/{scriptId}/notes/{noteId} {
      function isOwner() {
        return request.auth != null && request.auth.uid == userId;
      }
      allow read: if request.auth != null; // Any authenticated user can read notes
      allow write: if isOwner();
    }

    /**
     * @description Controls access to scenes within a script. Publicly readable but only owner can write.
     * @path /users/{userId}/scripts/{scriptId}/scenes/{sceneId}
     */
    match /users/{userId}/scripts/{scriptId}/scenes/{sceneId} {
      function isOwner() {
        return request.auth != null && request.auth.uid == userId;
      }
      allow read: if request.auth != null; // Any authenticated user can read scenes
      allow write: if isOwner();
    }
    
    /**
     * @description Controls access to comments within a script. Publicly readable but only owner can write.
     * @path /users/{userId}/scripts/{scriptId}/comments/{commentId}
     */
    match /users/{userId}/scripts/{scriptId}/comments/{commentId} {
        function isOwner() {
          return request.auth != null && request.auth.uid == userId;
        }

        // Any authenticated user can read comments, but only owner can write
        allow read: if request.auth != null;
        allow write: if isOwner();
    }

    /**
     * @description Controls access to outline items within a script. Publicly readable but only owner can write.
     * @path /users/{userId}/scripts/{scriptId}/outline/{outlineId}
     */
    match /users/{userId}/scripts/{scriptId}/outline/{outlineId} {
        function isOwner() {
          return request.auth != null && request.auth.uid == userId;
        }

        // Any authenticated user can read outline items, but only owner can write
        allow read: if request.auth != null;
        allow write: if isOwner();
    }

    /**
     * @description Controls access to the error reporting collection. Allows any
     * authenticated user to create a report, but allows no one to read or list them
     * to protect user data.
     * @path /error-reports/{reportId}
     */
    match /error-reports/{reportId} {
        function isSignedIn() {
            return request.auth != null;
        }

        allow create: if isSignedIn();
        allow read, list, update, delete: if false;
    }
  }
}
