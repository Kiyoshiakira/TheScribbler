/**
 * @fileoverview Firestore Security Rules for ScriptScribbler.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Users can only access their own data.
 *
 * Data Structure:
 * All data is nested under /users/{userId}, ensuring clear ownership. Scripts, characters,
 * notes, and scenes are subcollections under each user's scripts.
 *
 * Key Security Decisions:
 * - Users can only list data under their own user ID.
 * - Data types and the presence of fields are not strictly validated (prototyping mode).
 *
 * Denormalization for Authorization:
 *  - The `authorId` on scripts, characters, notes, and scenes is used for authorization checks
 * to avoid `get()` calls and enforce ownership.  This field must match the document's
 * parent `userId`.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects user profiles.
     * @path /users/{userId}
     * @allow (create) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' can create their own profile.
     * @deny (create) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' cannot create another user's profile.
     * @allow (get) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' can read their own profile.
     * @deny (get) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' cannot read another user's profile.
     * @allow (update) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' can update their own profile.
     * @deny (update) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' cannot update another user's profile.
     * @allow (delete) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' can delete their own profile.
     * @deny (delete) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' cannot delete another user's profile.
     * @principle Enforces user-ownership.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Protects scripts owned by a user.
     * @path /users/{userId}/scripts/{scriptId}
     * @allow (create) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' can create a script under their own user ID.
     * @deny (create) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' cannot create a script under another user's ID.
     * @allow (get) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' can read a script under their own user ID.
     * @deny (get) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' cannot read a script under another user's ID.
     * @allow (update) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' can update a script under their own user ID.
     * @deny (update) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' cannot update a script under another user's ID.
     * @allow (delete) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' can delete a script under their own user ID.
     * @deny (delete) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' cannot delete a script under another user's ID.
     * @principle Enforces user-ownership for scripts.
     */
    match /users/{userId}/scripts/{scriptId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Protects characters associated with a script.
     * @path /users/{userId}/scripts/{scriptId}/characters/{characterId}
     * @allow (create) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' can create a character under their own script.
     * @deny (create) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' cannot create a character under another user's script.
     * @allow (get) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' can read a character under their own script.
     * @deny (get) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' cannot read a character under another user's script.
     * @allow (update) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' can update a character under their own script.
     * @deny (update) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' cannot update a character under another user's script.
     * @allow (delete) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' can delete a character under their own script.
     * @deny (delete) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' cannot delete a character under another user's script.
     * @principle Enforces user-ownership for characters.
     */
    match /users/{userId}/scripts/{scriptId}/characters/{characterId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Protects notes associated with a script.
     * @path /users/{userId}/scripts/{scriptId}/notes/{noteId}
     * @allow (create) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' can create a note under their own script.
     * @deny (create) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' cannot create a note under another user's script.
     * @allow (get) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' can read a note under their own script.
     * @deny (get) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' cannot read a note under another user's script.
     * @allow (update) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' can update a note under their own script.
     * @deny (update) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' cannot update a note under another user's script.
     * @allow (delete) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' can delete a note under their own script.
     * @deny (delete) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' cannot delete a note under another user's script.
     * @principle Enforces user-ownership for notes.
     */
    match /users/{userId}/scripts/{scriptId}/notes/{noteId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Protects scenes associated with a script.
     * @path /users/{userId}/scripts/{scriptId}/scenes/{sceneId}
     * @allow (create) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' can create a scene under their own script.
     * @deny (create) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' cannot create a scene under another user's script.
     * @allow (get) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' can read a scene under their own script.
     * @deny (get) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' cannot read a scene under another user's script.
     * @allow (update) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' can update a scene under their own script.
     * @deny (update) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' cannot update a scene under another user's script.
     * @allow (delete) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' can delete a scene under their own script.
     * @deny (delete) User 'a4OQi7TrxzYjLzGR0v9ohoPgU4L2' cannot delete a scene under another user's script.
     * @principle Enforces user-ownership for scenes.
     */
    match /users/{userId}/scripts/{scriptId}/scenes/{sceneId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }

  // Helper functions
  function isSignedIn() {
    return request.auth != null;
  }

  function isOwner(userId) {
    return isSignedIn() && request.auth.uid == userId;
  }

  function isExistingOwner(userId) {
    return isOwner(userId) && resource != null;
  }
}