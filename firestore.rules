/**
 * @fileOverview Firestore Security Rules for ScriptScribbler.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. All user-generated content
 * (scripts, characters, notes, scenes) is stored in subcollections under the user's
 * unique ID, ensuring data isolation and simplifying security rules. It also includes
 * a rule for a public-write error reporting collection.
 *
 * Data Structure:
 * - /users/{userId}: Public-readable user profile information.
 * - /users/{userId}/scripts/{scriptId}: Core script documents.
 * - /users/{userId}/scripts/{scriptId}/[characters|notes|scenes|comments|versions]/{docId}: Subcollections for script data.
 * - /error-reports/{reportId}: Collection for users to submit error logs.
 *
 * Key Security Decisions:
 * - User profiles (`/users/{userId}`) are world-readable to facilitate future social features,
 *   but only the owner can write to their own profile.
 * - All script-related data is nested under the user path, making ownership checks straightforward.
 * - Users can write to the `error-reports` collection but cannot read or list them, protecting privacy.
 * - Users cannot list all other users in the system.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles. Profiles are world-readable
     * but only writable by the owner.
     * @path /users/{userId}
     */
    match /users/{userId} {
      function isOwner() {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get: if true; // Publicly readable profiles
      allow list: if false; // Prevent listing all users

      allow create, update, delete: if isOwner();

      /**
       * @description Catch-all rule for all script-related subcollections.
       * This ensures that all current and future subcollections are accessible
       * by the owner, even if specific rules aren't defined above.
       * @path /users/{userId}/** (all subcollections)
       */
      match /{document=**} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    /**
     * @description Controls access to the error reporting collection. Allows any
     * authenticated user to create a report, but allows no one to read or list them
     * to protect user data.
     * @path /error-reports/{reportId}
     */
    match /error-reports/{reportId} {
        allow create: if request.auth != null;
        allow read, list, update, delete: if false;
    }
  }
}
