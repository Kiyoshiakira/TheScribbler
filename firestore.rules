/**
 * @file Firebase Security Rules for ScriptScribbler application.
 *
 * @core_philosophy This ruleset enforces a strict user-ownership model for characters,
 * ensuring that only authenticated users can manage their own character data.
 *
 * @data_structure User profiles are stored under `/users/{userId}`, and each user's
 * characters are stored in a subcollection `/users/{userId}/characters/{characterId}`.
 *
 * @key_security_decisions User listing is disabled for privacy. Read/write access to characters
 * is restricted to the owning user. The ruleset is designed to be flexible on data shapes
 * to allow for rapid iteration but enforces authorization and relational integrity constraints.
 *
 * @denormalization_for_authorization  Each character document has an `userId` field that *must*
 * match the `userId` in the path. This avoids the need for complex queries to determine ownership.
 *
 * @structural_segregation All user-specific data is stored under the `/users/{userId}` path,
 * ensuring clear separation of concerns and simplifies access control.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Enforces access control for user profiles.
     * @path /users/{userId}
     * @allow (create) Authenticated user can create their own profile (id matches auth.uid).
     * @allow (get, update, delete) Authenticated user can only access their own profile.
     * @deny (create) Unauthenticated users cannot create profiles.
     * @deny (get, update, delete) Users cannot access other user's profiles.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // Allow a user to create their own profile if the userId matches their auth.uid.
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == request.auth.uid;

      // Only the user can read their own profile.
      allow get: if isSignedIn() && isOwner(userId);

      // Only the user can list their own profiles.
      allow list: if false;

      // Only the user can update their own profile, ensuring immutability of the id field.
      allow update: if isSignedIn() && isOwner(userId) && resource.data.id == request.resource.data.id && resource != null;

      // Only the user can delete their own profile.
      allow delete: if isSignedIn() && isOwner(userId) && resource != null;
    }

    /**
     * @description Enforces access control for characters owned by a specific user.
     * @path /users/{userId}/characters/{characterId}
     * @allow (create) Authenticated user can create a character under their own user ID.
     * @allow (get, list, update, delete) Authenticated user can only access their own characters.
     * @deny (create) Unauthenticated users cannot create characters.
     * @deny (get, list, update, delete) Users cannot access characters owned by other users.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/characters/{characterId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      // A user can create a character if signed in and the userId matches the path.
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;

      // Only the owner can read a character.
      allow get: if isSignedIn() && isOwner(userId);

      // Only the owner can list their characters.
      allow list: if isSignedIn() && isOwner(userId);

      // Only the owner can update a character, ensuring immutability of the userId field.
      allow update: if isSignedIn() && isExistingOwner(userId) && resource.data.userId == request.resource.data.userId;

      // Only the owner can delete a character.
      allow delete: if isSignedIn() && isExistingOwner(userId);
    }
  }
}