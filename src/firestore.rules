/**
 * @fileOverview Firestore Security Rules for ScriptScribbler.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. All user-generated content
 * (scripts, characters, notes, scenes) is stored in subcollections under the user's
 * unique ID, ensuring data isolation and simplifying security rules. It also includes
 * rules for public-write error and feedback collections.
 *
 * Data Structure:
 * - /users/{userId}: Public-readable user profile information.
 * - /users/{userId}/scripts/{scriptId}: Core script documents.
 * - /users/{userId}/scripts/{scriptId}/[characters|notes|scenes|comments|versions]/{docId}: Subcollections for script data.
 * - /error-reports/{reportId}: Collection for users to submit error logs.
 * - /feedback/{feedbackId}: Collection for users to submit feedback.
 *
 * Key Security Decisions:
 * - User profiles (`/users/{userId}`) are world-readable to facilitate future social features,
 *   but only the owner can write to their own profile.
 * - All script-related data is nested under the user path, making ownership checks straightforward.
 * - Authenticated users can write to the `error-reports` and `feedback` collections
 *   but cannot read from them, protecting privacy.
 * - Users cannot list all other users in the system.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles. Profiles are world-readable
     * but only writable by the owner.
     * @path /users/{userId}
     */
    match /users/{userId} {
      function isOwner() {
        return request.auth != null && request.auth.uid == userId;
      }

      allow get: if true; // Publicly readable profiles
      allow list: if false; // Prevent listing all users

      allow create, update, delete: if isOwner();
    }

    /**
     * @description Controls access to all script-related data. A user can only
     * access scripts and their subcollections if the {userId} in the path
     * matches their authenticated UID.
     * @path /users/{userId}/scripts/{scriptId} and its subcollections.
     */
    match /users/{userId}/{path=**} {
       function isOwner() {
        return request.auth != null && request.auth.uid == userId;
      }
      
      allow read, write: if isOwner();
    }
    
    /**
     * @description Controls access to comments within a script.
     * @path /users/{userId}/scripts/{scriptId}/comments/{commentId}
     */
    match /users/{userId}/scripts/{scriptId}/comments/{commentId} {
        function isOwner() {
          return request.auth != null && request.auth.uid == userId;
        }

        // Only the script owner can read/write comments for now.
        // This can be expanded for collaborators later.
        allow read, write: if isOwner();
    }
    
    /**
     * @description Controls access to versions within a script.
     * @path /users/{userId}/scripts/{scriptId}/versions/{versionId}
     */
    match /users/{userId}/scripts/{scriptId}/versions/{versionId} {
        function isOwner() {
          return request.auth != null && request.auth.uid == userId;
        }

        // Only the script owner can read/write versions.
        allow read, write: if isOwner();
    }


    /**
     * @description Controls access to the error reporting collection. Allows any
     * authenticated user to create a report, but allows no one to read or list them
     * to protect user data.
     * @path /error-reports/{reportId}
     */
    match /error-reports/{reportId} {
        function isSignedIn() {
            return request.auth != null;
        }

        allow create: if isSignedIn();
        allow read, list, update, delete: if false;
    }

    /**
     * @description Controls access to the feedback collection. Allows any
     * authenticated user to create (submit) feedback, but allows no one to
     * read, list, update, or delete other people's feedback to protect privacy.
     * @path /feedback/{feedbackId}
     */
    match /feedback/{feedbackId} {
        function isSignedIn() {
            return request.auth != null;
        }

        allow create: if isSignedIn();
        allow read, list, update, delete: if false;
    }
  }
}
